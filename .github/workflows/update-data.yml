name: Update Data

on:
  workflow_dispatch:  # Allow manual triggering
  schedule:
    - cron: '0 0 1 */3 *'  # Run on the first day of every third month (quarterly)

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # Adjust to your preferred Python version
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests polars

    - name: Check last known quarter before update
      run: |
        echo "BEFORE_UPDATE=$(cat last_known_quarter.txt)" >> $GITHUB_ENV
    
    - name: Run data update script
      id: run-script
      run: python main.py || echo "script_failed=true" >> $GITHUB_OUTPUT
    
    - name: Check last known quarter after update
      run: |
        echo "AFTER_UPDATE=$(cat last_known_quarter.txt)" >> $GITHUB_ENV
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/hogar_data.zip data/individual_data.zip last_known_quarter.txt
        git commit -m "Update data files" || echo "No changes to commit"
        git push
    
    - name: Slack Notification - Success
      if: steps.run-script.outputs.script_failed != 'true'
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "Data Update Workflow Succeeded ‚úÖ",
            "attachments": [
              {
                "color": "good",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Workflow Run",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Slack Notification - Failure
      if: failure() || steps.run-script.outputs.script_failed == 'true'
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "Data Update Workflow Failed ‚ùå",
            "attachments": [
              {
                "color": "danger",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Workflow Run",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: Slack Notification - Quarter Changed
      if: env.BEFORE_UPDATE != env.AFTER_UPDATE
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "Last Known Quarter Updated üîÑ",
            "attachments": [
              {
                "color": "good",
                "fields": [
                  {
                    "title": "Old Quarter",
                    "value": "${{ env.BEFORE_UPDATE }}",
                    "short": true
                  },
                  {
                    "title": "New Quarter",
                    "value": "${{ env.AFTER_UPDATE }}",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
